<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>使用 CATransaction flush设置cube动画的两个面</title>
        <meta name="viewport" content="width=device-width">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/stylesheets/main.css">

    </head>
	<body>	
		<!-- 灰长直 -->
<nav class="grey-long-straight">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/archives">Archives</a></li>
    <li><a href="https://github.com/Xummer">Github</a></li>
    <li><a href="http://weibo.com/xummers/" class="switchable" target="_blank">SinaWeibo</a></li>
    
    <li>
      <form action="http://google.com/search" method="get" target="_blank">
        <input type="hidden" name="q" value="site:" />
        <input type="text" name="q" class="search" placeholder="Search" x-webkit-speech />
      </form>
    </li>
    
  </ul>
</nav>

		<header class="my-nickname">
			<em>Xummer
			 </em>
		</header>
		

			<section class="main-wrap clearfix">
	<article role="article">
		<h1 class="entry-title">使用 CATransaction flush设置cube动画的两个面</h1>
		<p class="entry-meta">23 Jan 2013</p>

		<div class="entry-content">
			<p>最近项目动画比较多，主要用到<code>CATracnsaction</code>的<code>cube</code>动画。但是遇到个问题，举个例子来说：<code>self.view</code>一开始的背景颜色为灰色，在加<code>cube</code>动画之前设置<code>self.view</code>的背景为红色，会出现由灰色背景到红色背景的<code>cube</code>动画。如下图,  </p>

<p><img src="/images/blog-images/2013-1-23/noFlush.png" alt="">  </p>

<p>代码  </p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="n">setBackgroundColor</span><span class="o">:</span><span class="p">[</span><span class="n">UIColor</span> <span class="n">redColor</span><span class="p">]];</span>
<span class="n">CATransition</span> <span class="o">*</span><span class="n">transition</span> <span class="o">=</span> <span class="p">[</span><span class="n">CATransition</span> <span class="n">animation</span><span class="p">];</span>

<span class="n">transition</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">@&quot;alignedCube&quot;</span><span class="p">;</span>
<span class="n">transition</span><span class="p">.</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">kCATransitionFromTop</span><span class="p">;</span>
<span class="n">transition</span><span class="p">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
<span class="n">transition</span><span class="p">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="p">[</span><span class="n">CAMediaTimingFunction</span> <span class="n">functionWithName</span><span class="o">:</span><span class="n">kCAMediaTimingFunctionEaseInEaseOut</span><span class="p">];</span>
<span class="n">transition</span><span class="p">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="n">HUGE_VALF</span><span class="p">;</span>
<span class="c1">//    transition.repeatDuration = 1.0f</span>
<span class="n">transition</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
<span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">layer</span> <span class="n">addAnimation</span><span class="o">:</span><span class="n">transition</span> <span class="n">forKey</span><span class="o">:</span><span class="s">@&quot;transition&quot;</span><span class="p">];</span>
</code></pre></div>
<h2>使用[CATransaction flush]</h2>

<p>若在设置红色背景后加<code>[CATransaction flush];</code>就可以实现<code>cube</code>动画两个界面都是红色了。如图,  </p>

<p><img src="/images/blog-images/2013-1-23/withFlush.png" alt="">  </p>

<p>代码   </p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="n">setBackgroundColor</span><span class="o">:</span><span class="p">[</span><span class="n">UIColor</span> <span class="n">redColor</span><span class="p">]];</span>
<span class="p">[</span><span class="n">CATransaction</span> <span class="n">flush</span><span class="p">];</span>
<span class="n">CATransition</span> <span class="o">*</span><span class="n">transition</span> <span class="o">=</span> <span class="p">[</span><span class="n">CATransition</span> <span class="n">animation</span><span class="p">];</span>

<span class="n">transition</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">@&quot;alignedCube&quot;</span><span class="p">;</span>
<span class="n">transition</span><span class="p">.</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">kCATransitionFromTop</span><span class="p">;</span>
<span class="n">transition</span><span class="p">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
<span class="n">transition</span><span class="p">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="p">[</span><span class="n">CAMediaTimingFunction</span> <span class="n">functionWithName</span><span class="o">:</span><span class="n">kCAMediaTimingFunctionEaseInEaseOut</span><span class="p">];</span>
<span class="n">transition</span><span class="p">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="n">HUGE_VALF</span><span class="p">;</span>
<span class="c1">//    transition.repeatDuration = 1.0f</span>
<span class="n">transition</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
<span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">layer</span> <span class="n">addAnimation</span><span class="o">:</span><span class="n">transition</span> <span class="n">forKey</span><span class="o">:</span><span class="s">@&quot;transition&quot;</span><span class="p">];</span>
</code></pre></div>
<h2>总结</h2>

<p><code>CATransaction</code>的<code>cube</code>动画有一个缓存一样的机制，因为要显示两个<code>view</code>的<code>layer</code>，若不加<code>[CATransaction flush]</code>则系统默认为在<code>[self.view.layer addAnimation:transition forKey:@&quot;transition&quot;];</code>之前的对<code>view</code>的操作全部作为动画的内容。<code>addAnimation</code>时从缓存中取出之前的<code>view</code>的<code>layer</code>，作为<code>cube</code>中即将消失的一面，在将所有的改动后的<code>view</code>的<code>layer</code>作为<code>cube</code>新的一面。<code>[CATransaction flush]</code>起到了分割线的作用。</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text"> 之前，存入缓存，作为cube中即将消失的一面
 ------------------------
  [CATransaction flush];
 之后，改动view直到addAnimation之前作为cube中新的一面
 ------------------------
  [self.view.layer addAnimation:transition forKey:@&quot;transition&quot;];
</code></pre></div>
		</div>

		<footer>
			<p class="meta neighbor clearfix">
				
				<a href="/blog/custom-view-from-nib.html" class="basic-alignment left" title="Previous Post: 从nib初始化自定义view">&laquo; 从nib初始化自定义view</a>
				
				
				<a href="/blog/setup-debian-on-cubieboardan.html" class="basic-alignment right" title="Next Post: Cubieboard安装Debian">Cubieboard安装Debian &raquo;</a>
				
			</p>
		</footer>
	</article>

	
<div class="ds-thread" data-title="使用 CATransaction flush设置cube动画的两个面" data-image="http://tp3.sinaimg.cn/1649383490/180/5600400876/1"></div>
<script>var duoshuoQuery = { short_name: 'xummer' }</script>
<script src="http://static.duoshuo.com/embed.js" async="async"></script>


</section>


		

    </body>
	<footer class="footer">
		<span>&copy;Xummer, Since 1990.</span>
		<i>|</i>
		Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a>
	</footer>
</html>
