<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>图片压缩后原有旋转信息丢失</title>
        <meta name="viewport" content="width=device-width">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/stylesheets/main.css">

    </head>
	<body>	
		<!-- 灰长直 -->
<nav class="grey-long-straight">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/archives">Archives</a></li>
    <li><a href="https://github.com/Xummer">Github</a></li>
    <li><a href="http://weibo.com/xummers/" class="switchable" target="_blank">SinaWeibo</a></li>
    
    <li>
      <form action="http://google.com/search" method="get" target="_blank">
        <input type="hidden" name="q" value="site:" />
        <input type="text" name="q" class="search" placeholder="Search" x-webkit-speech />
      </form>
    </li>
    
  </ul>
</nav>

		<header class="my-nickname">
			<em>Xummer
			 </em>
		</header>
		

			<section class="main-wrap clearfix">
	<article role="article">
		<h1 class="entry-title">图片压缩后原有旋转信息丢失</h1>
		<p class="entry-meta">16 May 2013</p>

		<div class="entry-content">
			<p>近期做微博分享，iphone调用系统相机拍摄照片后，图片过大大概有15M左右，新浪微博最大支持5M的图片上传。所以必须先在本地做个压缩。  </p>

<h2>图片压缩方法</h2>

<ol>
<li>重绘，改变图片的size，来达到压缩的目的</li>
<li>图片格式转换，通过修改图片的质量来，改变图片的文件大小</li>
</ol>

<h2>修改图片质量</h2>

<p>先来看修改图片质量,系统提供了两个方法<br>
I、转png  </p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="n">NSData</span> <span class="o">*</span><span class="nf">UIImagePNGRepresentation</span><span class="p">(</span><span class="n">UIImage</span> <span class="o">*</span><span class="n">image</span><span class="p">);</span>                               
<span class="c1">// return image as PNG. May return nil if image has no CGImageRef or invalid bitmap format</span>
</code></pre></div>
<p>II、转jpeg</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="n">NSData</span> <span class="o">*</span><span class="nf">UIImageJPEGRepresentation</span><span class="p">(</span><span class="n">UIImage</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span> <span class="n">CGFloat</span> <span class="n">compressionQuality</span><span class="p">);</span>  
<span class="c1">// return image as JPEG. May return nil if image has no CGImageRef or invalid bitmap format. compression is 0(most)..1(least)</span>
</code></pre></div>
<p>具体来转换后的效果
之前测试的一个图片jpeg<br>
3.2M 原图<br>
5.5M <code>UIImageJPEGRepresentation(image, 1)</code><br>
385K <code>UIImageJPEGRepresentation(image, 0)</code><br>
14.1M<code>UIImagePNGRepresentation(image)</code>     </p>

<p>现在压缩一个小图 大家都丧心病狂的黑香菜<a href="http://wiki.acfun.tv/index.php?title=%E5%85%B5%E5%BA%93%E5%8C%97&amp;diff=0&amp;oldid=53841">兵库北</a>我也来黑下吧 括弧笑</p>

<p>测试代码  </p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="n">NSString</span> <span class="o">*</span><span class="n">filePath</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
<span class="n">UIImage</span> <span class="o">*</span><span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="n">imageNamed</span><span class="o">:</span><span class="s">@&quot;Bingkubei.jpg&quot;</span><span class="p">];</span>
<span class="n">filePath</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSTemporaryDirectory</span><span class="p">()</span> <span class="n">stringByAppendingFormat</span><span class="o">:</span><span class="s">@&quot;tmp.png&quot;</span><span class="p">];</span> <span class="c1">// 所有我都存成png的后缀了，大小貌似和后缀没什么关系。</span>
<span class="p">[</span><span class="n">UIImagePNGRepresentation</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="n">writeToFile</span><span class="o">:</span><span class="n">filePath</span> <span class="n">atomically</span><span class="o">:</span><span class="nb">YES</span><span class="p">];</span>
</code></pre></div>
<p>105k 原图<br>
<img src="/images/blog-images/2013-5-16/Bingkubei.jpg" alt=""><br>
259k <code>UIImageJPEGRepresentation(image, 1)</code><br>
<img src="/images/blog-images/2013-5-16/BingkubeiJpeg1.png" alt=""><br>
20k <code>UIImageJPEGRepresentation(image, 0)</code> 直接就渣画质了<br>
<img src="/images/blog-images/2013-5-16/BingkubeiJpeg0.png" alt=""><br>
596k <code>UIImagePNGRepresentation(image)</code><br>
<img src="/images/blog-images/2013-5-16/BingkubeiPNG.png" alt=""></p>

<hr>

<p>结论：压缩的话还是要用<code>UIImageJPEGRepresentation(image, 0.26)</code>这个方法。</p>

<h2>修改图片质量产生的问题</h2>

<p>修改图片质量后后图片的exif信息都丢失了，也就是说之前用iphone竖屏拍摄的照片在压缩存储后就变成横屏的（看上去倒过来了），iOS机器上看不出来，但是一分享到微博，问题就出现了。<br>
如下图：<br>
<img src="/images/blog-images/2013-5-16/shareSina.png" alt=""></p>

<h2>解决方法</h2>

<p>这里我们就要用到重绘了。在压缩存储前将图片重绘一次，应为这时候图片是带有旋转信息的，所以绘制出的是你拍摄正常方向的图片。之后再进行图片质量的压缩<code>UIImageJPEGRepresentation(image, 0.26)</code>。<br>
重绘代码</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="c1">// 重绘图片到指定宽度 clip:是否切处过长的边界切成正方形</span>
<span class="k">+</span> <span class="p">(</span><span class="n">UIImage</span> <span class="o">*</span><span class="p">)</span><span class="nf">scaleImage:</span><span class="p">(</span><span class="n">UIImage</span> <span class="o">*</span><span class="p">)</span><span class="nv">image</span> <span class="nf">newWidth:</span><span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="nv">iWidth</span> <span class="nf">clip:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">isClip</span> <span class="p">{</span>
    <span class="c1">//    NSLog(@&quot;image size:%f,%f&quot;,image.size.width, image.size.height);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">iWidth</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CGFloat</span> <span class="n">minValue</span> <span class="o">=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">image</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
        <span class="kt">float</span> <span class="n">scaleFloat</span> <span class="o">=</span> <span class="n">iWidth</span><span class="o">/</span><span class="n">minValue</span><span class="p">;</span>
        <span class="n">CGSize</span> <span class="n">size</span> <span class="o">=</span> <span class="n">CGSizeMake</span><span class="p">(</span><span class="n">isClip</span><span class="o">?</span><span class="n">iWidth</span><span class="o">:</span><span class="n">scaleFloat</span><span class="o">*</span><span class="n">image</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">isClip</span><span class="o">?</span><span class="n">iWidth</span><span class="o">:</span><span class="n">scaleFloat</span><span class="o">*</span><span class="n">image</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

        <span class="n">UIGraphicsBeginImageContext</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
        <span class="n">CGContextRef</span> <span class="n">context</span> <span class="o">=</span> <span class="n">UIGraphicsGetCurrentContext</span><span class="p">();</span>
        <span class="n">CGAffineTransform</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">CGAffineTransformIdentity</span><span class="p">;</span>

        <span class="n">transform</span> <span class="o">=</span> <span class="n">CGAffineTransformScale</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">scaleFloat</span><span class="p">,</span> <span class="n">scaleFloat</span><span class="p">);</span>
        <span class="n">CGContextConcatCTM</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">transform</span><span class="p">);</span>

        <span class="c1">// Draw the image into the transformed context and return the image</span>
        <span class="p">[</span><span class="n">image</span> <span class="n">drawAtPoint</span><span class="o">:</span><span class="n">CGPointMake</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">)];</span>
        <span class="n">UIImage</span> <span class="o">*</span><span class="n">newimg</span> <span class="o">=</span> <span class="n">UIGraphicsGetImageFromCurrentImageContext</span><span class="p">();</span>
        <span class="n">UIGraphicsEndImageContext</span><span class="p">();</span>

        <span class="k">return</span> <span class="n">newimg</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="n">image</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2>以上</h2>

		</div>

		<footer>
			<p class="meta neighbor clearfix">
				
				<a href="/blog/setup-debian-on-cubieboardan.html" class="basic-alignment left" title="Previous Post: Cubieboard安装Debian">&laquo; Cubieboard安装Debian</a>
				
				
				<a href="/blog/commit-to-github-with-emoj.html" class="basic-alignment right" title="Next Post: 在github commit中添加表情">在github commit中添加表情 &raquo;</a>
				
			</p>
		</footer>
	</article>

	
<div class="ds-thread" data-title="图片压缩后原有旋转信息丢失" data-image="http://tp3.sinaimg.cn/1649383490/180/5600400876/1"></div>
<script>var duoshuoQuery = { short_name: 'xummer' }</script>
<script src="http://static.duoshuo.com/embed.js" async="async"></script>


</section>


		

    </body>
	<footer class="footer">
		<span>&copy;Xummer, Since 1990.</span>
		<i>|</i>
		Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a>
	</footer>
</html>
