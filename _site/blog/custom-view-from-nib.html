<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>从nib初始化自定义view</title>
        <meta name="viewport" content="width=device-width">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/stylesheets/main.css">

    </head>
	<body>	
		<!-- 灰长直 -->
<nav class="grey-long-straight">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/archives">Archives</a></li>
    <li><a href="https://github.com/Xummer">Github</a></li>
    <li><a href="http://weibo.com/xummers/" class="switchable" target="_blank">SinaWeibo</a></li>
    
    <li>
      <form action="http://google.com/search" method="get" target="_blank">
        <input type="hidden" name="q" value="site:" />
        <input type="text" name="q" class="search" placeholder="Search" x-webkit-speech />
      </form>
    </li>
    
  </ul>
</nav>

		<header class="my-nickname">
			<em>Xummer
			 </em>
		</header>
		

			<section class="main-wrap clearfix">
	<article role="article">
		<h1 class="entry-title">从nib初始化自定义view</h1>
		<p class="entry-meta">13 Jan 2013</p>

		<div class="entry-content">
			<p>Xcode中用IB直接创建nib文件(PS:关于nib文件，之前的IB中所创建的可视化控件都是以nib结尾的，所以叫nib文件。虽然现在见不到nib了，都变为xib了但是还是称为nib文件)确实是很快，一些简单的view直接就可以用IB直接拖控件，节省了很多时间。在创建的UIViewController时确实很方便，但是创建自定义的UIView时却有一些麻烦。<br>
<img src="/images/blog-images/2012-1-13/newCustomView.png" alt=""><br>
创建时没有自带的xib的选项，所以创建完自定义view之后要直接拖控件的话得自己在创建一个xib文件并做连接。<br>
<img src="/images/blog-images/2012-1-13/newXib.png" alt="">   </p>

<p>设置xib的名称  </p>

<p><img src="/images/blog-images/2012-1-13/newXib2.png" alt="">  </p>

<del>之后将xib的File's Owner中的Custom Class改为刚才所创建的自定义view的名字我这是`TestView`。</del>  

<h3>之前没有完全理解File&#39;s Owner到底是用来干嘛的，写的有些错误。看了<a href="http://www.cnblogs.com/martin1009/archive/2012/06/01/2531028.html">这篇文章</a> ，里面说道</h3>

<hr>

<p>iPhone开发广义上来讲，采用MVC模型，即Model-View-Controller。其中：
    * Model为数据模型，比如用户配置文件；
    * View为显示的界面元素，比如一个按钮；
    * Controller为控制器，是Model和View之间进行沟通的桥梁。<br>
   其中View和Model之间不会直接通信，即Model只能与Controller之间进行彼此通信，View只能与Controller之间进行通信。</p>

<h2>File&#39;s Owner</h2>

<p>重点就是这里了，<code>View</code>和<code>ViewController</code>之间的对应关系，需要一个桥梁来进行连接的（即，对于一个视图，他如何知道自己的界面的操作应该由谁来响应），这个桥梁就是<code>File&#39;s Owner</code> 。<br>
   选中某个XIB的File&#39;s Owner，在Inspector中可以看到属性：File Name和Custom Class，该File&#39;s Owner就是用来绑定<code>File Name</code>中的xib文件和<code>Custom Class</code>中的<code>ViewController</code>的，在做了这个绑定之后，按住<code>control</code>键，拖动<code>File&#39;s Owner</code>到<code>xib</code>中的某个控件的时候，就是<code>Custom Class</code>中定义的<code>IBOutlet</code>元素与<code>xib</code>中元素进行连接的过程，同样，拖动&quot;<code>xib</code>中的控件的动作&quot;到<code>File&#39;s Owner</code>的时候，就是将<code>xib</code>中该动作的响应与<code>Custom Class</code>中某个<code>IBAction</code>进行连接的过程。<br>
   因此，在存在多个<code>xib</code>文件的情况下，即：有多个<code>View</code>，那么每个View可以采用不同的<code>ViewController</code>，也可以全部采用相同的一个<code>ViewController</code>，通过<code>File&#39;s Owner</code>进行关联即可。<br>
   其实，<code>File&#39;s Owner</code>就是<code>Custom Class</code>类型的对象，而<code>xib</code>中的其他元素都是该对象的成员变量，但是需要手动来关联<code>Custom Class</code>中的成员变量与<code>xib</code>中对象之间的关系。</p>

<hr>

<p>所以我们这边的xib并不需要关联到对应的<code>ViewController</code>，所以也不需要设置File&#39;s Owner。保持默认的<code>NSObject</code>就可以了。  </p>

<p><img src="/images/blog-images/2012-1-13/customClassRight.png" alt=""></p>

<p>需要设置的是Xib中的最底层view的<code>Custom Class</code>改为刚才所创建的自定义view的名字我这是<code>TestView</code></p>

<p><img src="/images/blog-images/2012-1-13/ObjectTestView.png" alt="">   </p>

<p><img src="/images/blog-images/2012-1-13/customClass.png" alt="">   </p>

<p>之后就可以拖控件了。拖IBOutlet的property。</p>

<hr>

<p>以上控件是拖好了，然后来说从xib文件中初始化实例。  </p>

<p>方法一，直接用</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="n">NSArray</span> <span class="o">*</span><span class="n">nibViews</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="n">loadNibNamed</span><span class="o">:</span><span class="s">@&quot;TestView&quot;</span> <span class="n">owner</span><span class="o">:</span><span class="n">self</span> <span class="n">options</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="n">TestView</span> <span class="o">*</span><span class="n">subView</span> <span class="o">=</span> <span class="p">[</span><span class="n">nibViews</span> <span class="n">objectAtIndex</span><span class="o">:</span><span class="mi">0</span><span class="p">];</span>
</code></pre></div>
<p>从nib文件中获取实例，应为这个实例是autorelease的，所以如果不是用ARC的同学自己retain一次。但是种种方法每次都这么初始化感觉比较麻烦。  </p>

<p>方法二，网上看到的方法，google搜自定义UIView搜到的基本上都是这个方法，但是存在很大的问题，不推荐。 </p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithNib</span> <span class="p">{</span>
    <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="n">init</span><span class="p">];</span> 
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSArray</span> <span class="o">*</span><span class="n">nibViews</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="n">loadNibNamed</span><span class="o">:</span><span class="s">@&quot;TestView&quot;</span> <span class="n">owner</span><span class="o">:</span><span class="n">self</span> <span class="n">options</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
        <span class="n">TestView</span> <span class="o">*</span><span class="n">subView</span> <span class="o">=</span> <span class="p">[</span><span class="n">nibViews</span> <span class="n">objectAtIndex</span><span class="o">:</span><span class="mi">0</span><span class="p">];</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="n">addsubView</span> <span class="n">subView</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>这就有个明显的问题，它是将取到的实例加在<code>self.view</code>上显示的，其实<code>subView</code>就已经是一个<code>TestView</code>的实例了,<code>self</code>自然也是一个<code>TestView</code>的实例。将<code>TestView</code>的实例加在另一个<code>TestView</code>实例上显示这感觉就多此一举了。而且还会存在一个问题，当<code>TestView</code>中有其他<code>property</code>这就会有问题出现了,比如这个<code>property</code>是<code>UILabel nameLabel</code>。当你具体要使用这个<code>nameLabel</code>是就会出现问题。如，</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="n">TestView</span> <span class="o">*</span><span class="n">tView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">TestView</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithNib</span><span class="p">];</span>
<span class="p">[</span><span class="n">tView</span><span class="p">.</span><span class="n">nameLabel</span> <span class="n">setText</span><span class="o">:</span><span class="s">@&quot;just 4 test&quot;</span><span class="p">];</span>
</code></pre></div>
<p>这里就会看到无论你怎么设置这个<code>nameLabel</code>都不能在UI上改变。
原因就是你<code>setText</code>的<code>nameLabel</code>就是上面的<code>self</code>这个实例A，而在UI上显示的则是从nib初始化出来的实例B<code>subView</code>。A和B不同，修改A，B还是B。<br>
虽然可以通过其他方式将A和B联系起来但是感觉还是多此一举。</p>

<p>方法三，其实也就是方法一，将他封装下而已，但是下面我们来看下关于ios内存管理的问题。</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithNib</span> <span class="p">{</span>
    <span class="n">NSArray</span> <span class="o">*</span><span class="n">nibViews</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="n">loadNibNamed</span><span class="o">:</span><span class="s">@&quot;TestView&quot;</span> <span class="n">owner</span><span class="o">:</span><span class="n">self</span> <span class="n">options</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="n">TestView</span> <span class="o">*</span><span class="n">subView</span> <span class="o">=</span> <span class="p">[</span><span class="n">nibViews</span> <span class="n">objectAtIndex</span><span class="o">:</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">subView</span> <span class="n">retain</span><span class="p">];</span> <span class="c1">//必须要retain </span>
<span class="p">}</span>
</code></pre></div>
<p>一般初始化之后，都<code>addSubview</code>到其他的<code>view</code>上去了。这种情况不<code>retain</code>也没有什么问题,因为<code>addSubview</code>中做了系统做了一次<code>retain</code>操作。但是需要用到<code>removeFromSuperview</code> 那问题就出现了。。。分析下主要是内存的管理问题,重新来看下自定义<code>view</code>的 <code>retainCount</code> </p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithNib</span> <span class="p">{</span>
    <span class="n">NSArray</span> <span class="o">*</span><span class="n">nibViews</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="n">loadNibNamed</span><span class="o">:</span><span class="s">@&quot;TestView&quot;</span> <span class="n">owner</span><span class="o">:</span><span class="n">self</span> <span class="n">options</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="n">TestView</span> <span class="o">*</span><span class="n">subView</span> <span class="o">=</span> <span class="p">[</span><span class="n">nibViews</span> <span class="n">objectAtIndex</span><span class="o">:</span><span class="mi">0</span><span class="p">];</span> <span class="c1">// [subView retainCount] = 1 为autorelease 内存地址0x1234 (随意定义说明用)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">subView</span> <span class="n">retain</span><span class="p">];</span> <span class="c1">//必须要retain         // [subView retainCount] = 2 内存地址0x1234</span>
<span class="p">}</span>
</code></pre></div>
<p>若没有<code>subview</code> 没有 <code>retain</code>那来分析下</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithNib</span> <span class="p">{</span>
    <span class="n">NSArray</span> <span class="o">*</span><span class="n">nibViews</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="n">loadNibNamed</span><span class="o">:</span><span class="s">@&quot;TestView&quot;</span> <span class="n">owner</span><span class="o">:</span><span class="n">self</span> <span class="n">options</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="n">TestView</span> <span class="o">*</span><span class="n">subView</span> <span class="o">=</span> <span class="p">[</span><span class="n">nibViews</span> <span class="n">objectAtIndex</span><span class="o">:</span><span class="mi">0</span><span class="p">];</span> <span class="c1">// [subView retainCount] = 1 为autorelease 内</span>
<span class="err">存地址</span><span class="mh">0x1234</span> <span class="p">(</span><span class="err">随意定义说明用</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">subView</span><span class="p">;</span>                         <span class="c1">// [subView retainCount] = 1 内存地址0x1234</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="k">@interface</span> <span class="nc">ViewController</span> : <span class="nc">UIViewController</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">retain</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">TestView</span> <span class="o">*</span><span class="n">testView</span><span class="p">;</span>
<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">ViewController</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">initTestView</span> <span class="p">{</span>
    <span class="n">TestView</span> <span class="o">*</span><span class="n">tView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">TestView</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithNib</span><span class="p">];</span> <span class="c1">// [tView retainCount] = 1   autorelease 内存地址0x1234</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="n">addSubview</span><span class="o">:</span><span class="n">tView</span><span class="p">];</span>                     <span class="c1">// [tView retainCount] = 2 内存地址0x1234</span>
    <span class="n">self</span><span class="p">.</span><span class="n">testView</span>  <span class="o">=</span> <span class="n">tView</span><span class="p">;</span>                           <span class="c1">// [testView retainCount] = 3 内存地址0x1234</span>
    <span class="p">[</span><span class="n">tView</span> <span class="n">release</span><span class="p">];</span>                                  <span class="c1">// [testView retainCount] = 2 内存地址0x1234</span>
<span class="p">}</span>
    <span class="cm">/*</span>
<span class="cm">     …        //tView 的 @autoreleasepool销毁        [testView retainCount] = 1 内存地址为0x1234</span>
<span class="cm">    */</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">removeTestViewFromSuper</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">_testView</span> <span class="n">removeFromSuperview</span><span class="p">];</span>                 <span class="c1">// [testView retainCount] = 0 内存地址0x1234  调用TestView的dealloc函数销毁，但是0x1234内存地址的所对应的值未被置为nil</span>
<span class="p">}</span>
    <span class="cm">/* </span>
<span class="cm">     … self 的retainCount = 0 系统调用dealloc销毁self  但是dealloc中存在 [_testView release];       系统对0x1234发送release消息，导致crash</span>
<span class="cm">    */</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">dealloc</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">_testView</span> <span class="n">release</span><span class="p">];</span>                             <span class="c1">// testView 的实例已经不存在 </span>
    <span class="p">[</span><span class="n">super</span> <span class="n">dealloc</span><span class="p">];</span>
<span class="p">}</span>     

<span class="k">@end</span>
</code></pre></div>
<p>所以还是推荐第三种方法，必须加<code>retain</code>。</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithNib</span> <span class="p">{</span>
    <span class="n">NSArray</span> <span class="o">*</span><span class="n">nibViews</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="n">loadNibNamed</span><span class="o">:</span><span class="s">@&quot;TestView&quot;</span> <span class="n">owner</span><span class="o">:</span><span class="n">self</span> <span class="n">options</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="n">TestView</span> <span class="o">*</span><span class="n">subView</span> <span class="o">=</span> <span class="p">[</span><span class="n">nibViews</span> <span class="n">objectAtIndex</span><span class="o">:</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/*          做view的初始化操作        */</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">subView</span> <span class="n">retain</span><span class="p">];</span>  
<span class="p">}</span>
</code></pre></div>
		</div>

		<footer>
			<p class="meta neighbor clearfix">
				
				<a href="/blog/ios-handle-albums.html" class="basic-alignment left" title="Previous Post: ios系统相册选择视频后的处理">&laquo; ios系统相册选择视频后的处理</a>
				
				
				<a href="/blog/cube-animation.html" class="basic-alignment right" title="Next Post: 使用 CATransaction flush设置cube动画的两个面">使用 CATransaction flush设置cube动画的两个面 &raquo;</a>
				
			</p>
		</footer>
	</article>

	
<div class="ds-thread" data-title="从nib初始化自定义view" data-image="http://tp3.sinaimg.cn/1649383490/180/5600400876/1"></div>
<script>var duoshuoQuery = { short_name: 'xummer' }</script>
<script src="http://static.duoshuo.com/embed.js" async="async"></script>


</section>


		

    </body>
	<footer class="footer">
		<span>&copy;Xummer, Since 1990.</span>
		<i>|</i>
		Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a>
	</footer>
</html>
